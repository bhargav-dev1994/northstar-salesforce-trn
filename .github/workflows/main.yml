name: Salesforce Deployment

on:
  push:
    branches:
      - Dev1
      - SIT
      - UAT

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'

      - name: Install Salesforce CLI
        run: |
          echo "Installing Salesforce CLI..."
          npm install -g @salesforce/cli
        env:
          SF_USERNAME_DEV1: ${{ secrets.SF_USERNAME_DEV1 }}
          SF_PASSWORD_DEV1: ${{ secrets.SF_PASSWORD_DEV1 }}
          SF_USERNAME_SIT: ${{ secrets.SF_USERNAME_SIT }}
          SF_PASSWORD_SIT: ${{ secrets.SF_PASSWORD_SIT }}
          SF_USERNAME_UAT: ${{ secrets.SF_USERNAME_UAT }}
          SF_PASSWORD_UAT: ${{ secrets.SF_PASSWORD_UAT }}
          SF_USERNAME_PROD: ${{ secrets.SF_USERNAME_PROD }}
          SF_PASSWORD_PROD: ${{ secrets.SF_PASSWORD_PROD }}
          SF_SERVERURL_PROD: ${{ secrets.SF_SERVERURL_PROD }}
          SF_SERVERURL_SANDBOX: ${{ secrets.SF_SERVERURL_SANDBOX }}

      - name: Verify Salesforce CLI Installation
        run: |
          sfdx --version

      - name: Set Environment Variables
        run: |
          echo "Setting environment variables..."
          echo "SF_USERNAME=${{ secrets.SF_USERNAME_DEV1 }}" >> $GITHUB_ENV
          echo "SF_PASSWORD=${{ secrets.SF_PASSWORD_DEV1 }}" >> $GITHUB_ENV
          echo "SF_SERVERURL=${{ secrets.SF_SERVERURL_SANDBOX }}" >> $GITHUB_ENV

      - name: Build and Deploy to Salesforce
        run: |
          echo "Running Ant build..."
          ant -lib ./lib -f build.xml deploy -Dsf.username=${{ secrets.SF_USERNAME_DEV1 }} -Dsf.password=${{ secrets.SF_PASSWORD_DEV1 }} -Dsf.serverurl=${{ secrets.SF_SERVERURL_SANDBOX }} -Dorg.alias=Dev1
        env:
          SF_USERNAME_DEV1: ${{ secrets.SF_USERNAME_DEV1 }}
          SF_PASSWORD_DEV1: ${{ secrets.SF_PASSWORD_DEV1 }}
          SF_SERVERURL_SANDBOX: ${{ secrets.SF_SERVERURL_SANDBOX }}

  deploy-to-sit:
    runs-on: windows-latest
    needs: build
    if: github.ref == 'refs/heads/SIT'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Environment Variables for SIT
        run: |
          echo "Setting environment variables for SIT..."
          echo "SF_USERNAME=${{ secrets.SF_USERNAME_SIT }}" >> $GITHUB_ENV
          echo "SF_PASSWORD=${{ secrets.SF_PASSWORD_SIT }}" >> $GITHUB_ENV
          echo "SF_SERVERURL=${{ secrets.SF_SERVERURL_SANDBOX }}" >> $GITHUB_ENV

      - name: Deploy to SIT
        run: |
          echo "Deploying to SIT..."
          ant -lib ./lib -f build.xml deploy -Dsf.username=${{ secrets.SF_USERNAME_SIT }} -Dsf.password=${{ secrets.SF_PASSWORD_SIT }} -Dsf.serverurl=${{ secrets.SF_SERVERURL_SANDBOX }} -Dorg.alias=SIT

  deploy-to-uat:
    runs-on: windows-latest
    needs: build
    if: github.ref == 'refs/heads/UAT'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Environment Variables for UAT
        run: |
          echo "Setting environment variables for UAT..."
          echo "SF_USERNAME=${{ secrets.SF_USERNAME_UAT }}" >> $GITHUB_ENV
          echo "SF_PASSWORD=${{ secrets.SF_PASSWORD_UAT }}" >> $GITHUB_ENV
          echo "SF_SERVERURL=${{ secrets.SF_SERVERURL_SANDBOX }}" >> $GITHUB_ENV

      - name: Deploy to UAT
        run: |
          echo "Deploying to UAT..."
          ant -lib ./lib -f build.xml deploy -Dsf.username=${{ secrets.SF_USERNAME_UAT }} -Dsf.password=${{ secrets.SF_PASSWORD_UAT }} -Dsf.serverurl=${{ secrets.SF_SERVERURL_SANDBOX }} -Dorg.alias=UAT

  deploy-to-prod:
    runs-on: windows-latest
    needs: build
    if: github.ref == 'refs/heads/Master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set Environment Variables for Prod
        run: |
          echo "Setting environment variables for Prod..."
          echo "SF_USERNAME=${{ secrets.SF_USERNAME_PROD }}" >> $GITHUB_ENV
          echo "SF_PASSWORD=${{ secrets.SF_PASSWORD_PROD }}" >> $GITHUB_ENV
          echo "SF_SERVERURL=${{ secrets.SF_SERVERURL_PROD }}" >> $GITHUB_ENV

      - name: Deploy to Prod
        run: |
          echo "Deploying to Prod..."
          ant -lib ./lib -f build.xml deploy -Dsf.username=${{ secrets.SF_USERNAME_PROD }} -Dsf.password=${{ secrets.SF_PASSWORD_PROD }} -Dsf.serverurl=${{ secrets.SF_SERVERURL_PROD }} -Dorg.alias=Prod
